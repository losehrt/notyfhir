<div class="max-w-4xl mx-auto p-6">
  <h1 class="text-2xl font-bold mb-6">é€šçŸ¥è¨­å®š</h1>
  
  <div class="bg-white rounded-lg shadow p-6 mb-6">
    <h2 class="text-lg font-semibold mb-4">æ¨æ’­é€šçŸ¥</h2>
    
    <!-- è‡¨æ™‚æ¸¬è©¦æŒ‰éˆ• -->
    <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded">
      <p class="text-sm mb-2">æ¸¬è©¦æ¨æ’­åŠŸèƒ½</p>
      <%= form_with url: test_notification_settings_path, method: :post, local: true do |f| %>
        <%= f.submit "ç™¼é€æ¸¬è©¦é€šçŸ¥", class: "bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 cursor-pointer" %>
      <% end %>
    </div>
    
    <div id="notification-status" class="mb-4">
      <p class="text-gray-600">æª¢æŸ¥æ¨æ’­æ”¯æ´ç‹€æ…‹...</p>
    </div>
    
    <div id="notification-permission" class="mb-4" style="display: none;">
      <button id="enable-notifications" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
        å•Ÿç”¨é€šçŸ¥
      </button>
    </div>
    
    <div id="notification-enabled" style="display: none;">
      <p class="text-green-600 mb-4">æ¨æ’­é€šçŸ¥å·²å•Ÿç”¨</p>
      
      <%= form_with url: test_notification_settings_path, method: :post, local: true, class: "mb-4" do |f| %>
        <%= f.submit "ç™¼é€æ¸¬è©¦é€šçŸ¥", class: "bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 cursor-pointer" %>
      <% end %>
      
      <button id="disable-notifications" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
        åœç”¨é€šçŸ¥
      </button>
    </div>
  </div>
  
  <div class="bg-white rounded-lg shadow p-6">
    <h2 class="text-lg font-semibold mb-4">å·²è¨»å†Šè£ç½®</h2>
    <%= turbo_frame_tag "push_subscriptions" do %>
      <ul id="push_subscriptions_list" class="space-y-2">
        <% if @push_subscriptions.any? %>
          <%= render partial: "notyfhir/push_subscriptions/push_subscription", collection: @push_subscriptions %>
        <% else %>
          <li id="empty-state" class="text-gray-500 text-center py-4">å°šç„¡å·²è¨»å†Šçš„è£ç½®</li>
        <% end %>
      </ul>
    <% end %>
  </div>
</div>

<script>
  const vapidPublicKey = '<%= @vapid_public_key %>';
  const pushSubscriptionUrl = '<%= push_subscriptions_path %>';
  
  function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding)
      .replace(/\-/g, '+')
      .replace(/_/g, '/');
    
    const rawData = window.atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    
    for (let i = 0; i < rawData.length; ++i) {
      outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
  }
  
  async function checkNotificationSupport() {
    const statusEl = document.getElementById('notification-status');
    const permissionEl = document.getElementById('notification-permission');
    const enabledEl = document.getElementById('notification-enabled');
    
    if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
      // æª¢æŸ¥æ˜¯å¦ç‚º iOS
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      
      if (isIOS) {
        // æª¢æŸ¥æ˜¯å¦ç‚º PWA æ¨¡å¼
        const isStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
        
        if (!isStandalone) {
          statusEl.innerHTML = `
            <div class="text-amber-600 space-y-2">
              <p class="font-semibold">iOS æ¨æ’­é€šçŸ¥è¨­å®šæ­¥é©Ÿï¼š</p>
              <ol class="list-decimal list-inside space-y-1 text-sm">
                <li>é»æ“Š Safari åº•éƒ¨çš„ã€Œåˆ†äº«ã€æŒ‰éˆ• <span class="inline-block">â¬†ï¸</span></li>
                <li>é¸æ“‡ã€ŒåŠ å…¥ä¸»ç•«é¢ã€</li>
                <li>å¾ä¸»ç•«é¢é–‹å•Ÿæ­¤æ‡‰ç”¨ç¨‹å¼</li>
                <li>å†æ¬¡é€²å…¥é€šçŸ¥è¨­å®šå³å¯å•Ÿç”¨æ¨æ’­</li>
              </ol>
              <p class="text-xs mt-2">è¨»ï¼šiOS 16.4+ æ‰æ”¯æ´ç¶²é æ¨æ’­é€šçŸ¥</p>
            </div>
          `;
          return;
        }
      } else {
        statusEl.innerHTML = '<p class="text-red-600">æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´æ¨æ’­é€šçŸ¥</p>';
        return;
      }
    }
    
    // æª¢æŸ¥ç•¶å‰çš„é€šçŸ¥æ¬Šé™ç‹€æ…‹
    const permission = Notification.permission;
    console.log('Current notification permission:', permission);
    
    if (permission === 'denied') {
      statusEl.innerHTML = `
        <div class="text-red-600 space-y-2">
          <p>é€šçŸ¥æ¬Šé™å·²è¢«æ‹’çµ•</p>
          <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
            <p class="font-semibold mb-2">å¦‚ä½•é‡æ–°å…è¨±é€šçŸ¥æ¬Šé™ï¼š</p>
            <ol class="list-decimal list-inside space-y-1 text-sm">
              <li>é»æ“Šç€è¦½å™¨ç¶²å€åˆ—å·¦å´çš„ğŸ”’åœ–ç¤º</li>
              <li>æ‰¾åˆ°ã€Œé€šçŸ¥ã€è¨­å®š</li>
              <li>å°‡æ¬Šé™å¾ã€Œå°é–ã€æ”¹ç‚ºã€Œå…è¨±ã€</li>
              <li>é‡æ–°è¼‰å…¥æ­¤é é¢</li>
            </ol>
          </div>
        </div>
      `;
      statusEl.style.display = 'block';
      permissionEl.style.display = 'none';
      enabledEl.style.display = 'none';
      return;
    }
    
    try {
      const registration = await navigator.serviceWorker.ready;
      const subscription = await registration.pushManager.getSubscription();
      
      if (subscription) {
        statusEl.style.display = 'none';
        enabledEl.style.display = 'block';
      } else {
        statusEl.style.display = 'none';
        permissionEl.style.display = 'block';
      }
    } catch (error) {
      console.error('Error checking notification support:', error);
      statusEl.innerHTML = '<p class="text-red-600">éŒ¯èª¤: ' + error.message + '</p>';
      statusEl.style.display = 'block';
    }
  }
  
  document.getElementById('enable-notifications')?.addEventListener('click', async () => {
    try {
      const permission = await Notification.requestPermission();
      
      if (permission !== 'granted') {
        alert('é€šçŸ¥æ¬Šé™è¢«æ‹’çµ•');
        return;
      }
      
      const registration = await navigator.serviceWorker.ready;
      const subscription = await registration.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
      });
      
      const response = await fetch(pushSubscriptionUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
        },
        body: JSON.stringify(subscription)
      });
      
      if (response.ok) {
        // ç›´æ¥é‡æ–°è¼‰å…¥é é¢ä»¥ç¢ºä¿ç‹€æ…‹æ­£ç¢ºæ›´æ–°
        location.reload();
      }
    } catch (error) {
      console.error('Error enabling notifications:', error);
      alert('å•Ÿç”¨é€šçŸ¥å¤±æ•—');
    }
  });
  
  document.getElementById('disable-notifications')?.addEventListener('click', async () => {
    try {
      const registration = await navigator.serviceWorker.ready;
      const subscription = await registration.pushManager.getSubscription();
      
      if (subscription) {
        await subscription.unsubscribe();
        
        await fetch(pushSubscriptionUrl, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
          },
          body: JSON.stringify({ endpoint: subscription.endpoint })
        });
        
        location.reload();
      }
    } catch (error) {
      console.error('Error disabling notifications:', error);
    }
  });
  
  // Check support on page load
  window.addEventListener('DOMContentLoaded', () => {
    checkNotificationSupport();
  });
</script>